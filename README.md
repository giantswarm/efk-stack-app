[![CircleCI](https://circleci.com/gh/giantswarm/efk-stack-app.svg?style=shield)](https://circleci.com/gh/giantswarm/efk-stack-app)

# efk-stack-app chart

Giant Swarm offers a Opendistro Managed App which can be installed in tenant clusters.
Here we define the Opendistro chart with its templates and default configuration.

This application is intended to have a centralized log storage for your applications, it's not meant to be long term storage and is prepared to delete old indexes (7 days by default)

[Changelog](./CHANGELOG.md)

## Compatibility
- AWS: 9.0.0+
- Azure: 9.0.0+
- KVM: 9.0.0+       (Persistent volumes are required)

## Features
- OpenDistro Elasticsearch with security enabled
- Transport certificates autogenerated for 5 years
- **Curator will delete indices older than 7 days**
- Fluentd will collect all logs from pods **not** deployed in the namespaces: default, giantswarm, efk-stack-app, kube-node-lease, kube-public and kube-system.

## Additional information

- If you change the name of the helm release from "efk-stack-app" to "logging-stack" you will need to adapt default configuration and change all references of "efk-stack-app-opendistro-es-client-service" to "logging-stack-opendistro-es-client-service" in the [values file](./helm/efk-stack-app/values.yaml)

## Components

### OpenDistro
OSS Elasticsearch distribution.

[Additional info](./helm/efk-stack-app/charts/opendistro-es/README.md)

### OpenDistro Certificate Generator
Generates the certificates to start OpenDistro in a secure way. It will create a rootCA and the certificate that will be used to stablish communications between nodes.

[Additional info](./helm/efk-stack-app/charts/opendistro-certs/README.md)

### ElasticSearch Exporter
Exposes Prometheus metrics that can be explored with https://grafana.com/grafana/dashboards/2322

[Additional info](./helm/efk-stack-app/charts/elasticsearch-exporter/README.md)

### ElasticSearch Curator
Manages ElasticSearch indexes lifecycle, by default is configured to delete indices older than 7 days.

[Additional info](./helm/efk-stack-app/charts/elasticsearch-curator/README.md)

### FluentD
Log collector and parser that will send pod logs to ElasticSearch.

[Additional info](./helm/efk-stack-app/charts/fluentd/README.md)


## Configuration

This chart is composed of multiple helm charts and each can be configured from a single values file with the following format:

```
opendistro-certs:
  Check ./helm/efk-stack-app/charts/opendistro-certs/values.yaml

elasticsearch-curator:
  Check ./helm/efk-stack-app/charts/elasticsearch-curator/values.yaml

elasticsearch-exporter:
  Check ./helm/efk-stack-app/charts/elasticsearch-exporter/values.yaml

fluentd:
  Check ./helm/efk-stack-app/charts/fluentd/values.yaml

opendistro-es:
  Check ./helm/efk-stack-app/charts/opendistro-es/values.yaml
```

Check [default values file](./helm/efk-stack-app/values.yaml) for all components.

This configuration has been tuned by our team to give sane defaults for all components and modifying the internal_users.yaml file should be enough in most cases.

## Example Configurations

Here are some example configurations for getting this App running on your cluster.
Make sure you change the `hosts:` keys to something that matches your installation
and cluster id.

The files here can be downloaded, edited, and uploaded directly as the 'values.yaml'
during the installation step in our Web UI. If you are not using the web interface
to install your app, then you must place these values into a user level ConfigMap formatted
in the right way and reference it from the App CR. Read our [reference on app configuration](https://docs.giantswarm.io/reference/app-configuration/) for more details.


[AWS Example Configuration](./example_values/ingress_enabled_aws.yaml)

    Do not use in production, just for testing

    Default user: admin/admin

[Azure Example Configuration](./example_values/ingress_enabled_azure.yaml)

    Do not use in production, just for testing

    Default user: admin/admin

[Security Configuration](./example_values/security_config.yaml)

    Modify internal_users.yml before deploying the application

    Default user: admin/test

    You will need to create additional resources in kubernetes to make it more secure:

        $ kubectl create secret generic -n efk-stack-app opendistro-security-config --from-file=config_examples/config.yml
        $ kubectl create secret generic -n efk-stack-app opendistro-internal-users --from-file=config_examples/internal_users.yml

    You need to change the password values in internal_users.yml file and adjust the values in security_config.yaml accordingly.


## Credit

* https://github.com/opendistro-for-elasticsearch/community/tree/master/open-distro-elasticsearch-kubernetes

* https://github.com/justwatchcom/elasticsearch_exporter

* https://github.com/kiwigrid/helm-charts/tree/master/charts/fluentd-elasticsearch
